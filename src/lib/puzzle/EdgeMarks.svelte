<script>
	import { fade } from 'svelte/transition';

	/** @type {Number} i*/
	export let i;
	/**
	 * @type {import('$lib/puzzle/game').PipesGame} game
	 */
	export let game;
	export let cx = 0;
	export let cy = 0;

	let state = game.tileStates[i];

	const {scaleX, scaleY, skewX, skewY, rotateTh, translateX, translateY} = game.grid.getTileTransform(i);
	let transform = null;
	$: transform = `translate(${cx + (translateX || 0)}px, ${cy + (translateY || 0)}px) rotate(${rotateTh || 0}rad) skew(${skewX || 0}rad, ${skewY || 0}rad) scale(${scaleX || 1}, ${scaleY || 1})`;

	/**
	 *
	 * @param {import('$lib/puzzle/game').EdgeMark[]} marks
	 */
	function visibleMarks(marks) {
		/**
		 * @type {{x1:number, x2: number, y1: number, y2:number, state: import('$lib/puzzle/game').EdgeMark, direction:number}[]}
		 */
		const visible = [];
		marks.forEach((state, index) => {
			if (state === 'none' || state === 'empty') {
				return;
			}
			const direction = game.grid.EDGEMARK_DIRECTIONS[index];
			const { x1, y1, x2, y2 } = game.grid.getEdgemarkLine(direction, i);
			visible.push({
				x1,
				y1,
				x2,
				y2,
				state,
				direction
			});
		});
		return visible;
	}

	$: visibleEdgeMarks = visibleMarks($state.edgeMarks);
</script>

<g class="edgemarks" style="transform: {transform}">
	{#each visibleEdgeMarks as { x1, y1, x2, y2, state, direction } (direction)}
		<line
			transition:fade|local={{ duration: 100 }}
			class="mark"
			class:wall={state === 'wall'}
			{x1}
			{y1}
			{x2}
			{y2}
			stroke="green"
			stroke-width="0.04"
		/>
	{/each}
</g>

<style>
	.mark {
		transform-origin: center;
		transform-box: fill-box;
		transition: transform 100ms;
	}
	.wall {
		stroke: #ff3e00;
		transform: rotate(90deg);
	}
</style>
